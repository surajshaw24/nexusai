<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexusAI ‚Äî Your Advanced AI Assistant</title>
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTmV4dXNBSSIsInNob3J0X25hbWUiOiJOZXh1c0FJIiwiZGVzY3JpcHRpb24iOiJBbiBhZHZhbmNlZCBBSSBhc3Npc3RhbnQgd2l0aCBvZmZsaW5lIHN1cHBvcnQsIHZvaWNlLCBpbWFnZSwgYW5kIHByZXJlbWlldG9yIGRldmljZS4iLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzZDNUNFNyIsInRoZW1lX2NvbG9yIjoiIzZDNUNFNyIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3BuZztibWFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFBRUFBQUFCb0FBQUFBQURKQ29CQWdDQUFBQWlEQkFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFB......" sizes="192x192" type="image/png">
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAYAAABw4pVUAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAB3RJTUUH5gYUDi4K9fZzqAAAAZJJREFUeNrt0jEKwkAQheFXMlF8A5sSvLW0tLa2t7c28n9u6aJr27b9/28wJ0mYk3PmXO7M7Jy9672139539419779367333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333jv77X13X9n3/rv33r333......" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6C5CE7;
            --secondary: #A29BFE;
            --text: #2D3436;
            --bg: #F5F6FA;
            --card-bg: #FFFFFF;
            --input-bg: #FFFFFF;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --hover-effect: brightness(0.95);
            --success: #00B894;
            --warning: #FDCC5D;
            --error: #D63031;
            --border-radius: 18px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .dark-mode {
            --primary: #A78BFA;
            --secondary: #7E57C2;
            --text: #ECF0F1;
            --bg: #1A1A2E;
            --card-bg: #16213E;
            --input-bg: #0F3460;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            --hover-effect: brightness(1.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            transition: var(--transition);
        }

        body {
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            position: relative;
            touch-action: manipulation;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 100;
            user-select: none;
        }

        .logo {
            font-weight: 700;
            font-size: 1.4rem;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--input-bg);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text);
            font-size: 1.1rem;
            transition: transform 0.2s, background 0.3s;
            position: relative;
            touch-action: manipulation;
        }

        .header-btn:hover {
            filter: var(--hover-effect);
            transform: scale(1.05);
            background: rgba(108, 92, 231, 0.1);
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            overflow: hidden;
            position: relative;
            border: 2px solid rgba(255,255,255,0.2);
        }

        .user-avatar::after {
            content: '';
            position: absolute;
            inset: 0;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .user-avatar:hover::after {
            opacity: 1;
        }

        /* Chat Container */
        .chat-container {
            height: calc(100vh - 140px);
            overflow-y: auto;
            padding: 16px;
            scroll-behavior: smooth;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(108, 92, 231, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(162, 155, 254, 0.03) 0%, transparent 20%);
            background-size: 300px 300px;
            background-position: 0 0, 100% 100%;
            background-repeat: no-repeat;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            margin-bottom: 18px;
            max-width: 90%;
            animation: fadeIn 0.4s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            margin-left: auto;
            align-items: flex-end;
        }

        .ai-message {
            margin-right: auto;
            align-items: flex-start;
        }

        .message-bubble {
            padding: 14px 18px;
            border-radius: var(--border-radius);
            line-height: 1.6;
            font-size: 0.95rem;
            position: relative;
            max-width: 100%;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            overflow-wrap: break-word;
        }

        .user-message .message-bubble {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-top-right-radius: 4px;
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.3);
        }

        .ai-message .message-bubble {
            background: var(--card-bg);
            border-top-left-radius: 4px;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .dark-mode .ai-message .message-bubble {
            border-color: rgba(255,255,255,0.1);
        }

        .message-bubble img {
            max-width: 100%;
            border-radius: 12px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
        }

        .dark-mode .message-bubble img {
            border-color: rgba(255,255,255,0.1);
        }

        .message-sender {
            font-size: 0.75rem;
            color: var(--text);
            opacity: 0.8;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.6;
            margin-top: 4px;
        }

        .message-actions {
            display: flex;
            gap: 6px;
            margin-top: 8px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action-btn {
            background: none;
            border: none;
            color: var(--text);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px;
            border-radius: 4px;
            opacity: 0.7;
            touch-action: manipulation;
        }

        .message-action-btn:hover {
            opacity: 1;
            background: rgba(0,0,0,0.05);
        }

        .dark-mode .message-action-btn:hover {
            background: rgba(255,255,255,0.05);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: inline-flex;
            gap: 6px;
            align-items: center;
            margin-top: 8px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.7);
            animation: typingAnimation 1.4s infinite both;
        }

        .ai-message .typing-dot {
            background: var(--primary);
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Code Block Styling */
        .code-block {
            background: #f6f8fa;
            border-radius: 8px;
            padding: 12px;
            margin: 12px 0;
            overflow-x: auto;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            border-left: 4px solid var(--primary);
        }

        .dark-mode .code-block {
            background: #1e293b;
            border-left-color: var(--secondary);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.8rem;
            color: #666;
        }

        .copy-code-btn {
            background: transparent;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            touch-action: manipulation;
        }

        .copy-code-btn:hover {
            background: rgba(0,0,0,0.05);
            color: var(--primary);
        }

        .dark-mode .copy-code-btn:hover {
            background: rgba(255,255,255,0.05);
        }

        /* Input Area */
        .input-area {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            z-index: 50;
            border-top: 1px solid rgba(0,0,0,0.05);
            user-select: none;
        }

        .dark-mode .input-area {
            border-top-color: rgba(255,255,255,0.05);
        }

        .input-wrapper {
            flex: 1;
            background: var(--input-bg);
            border-radius: 24px;
            padding: 4px 16px;
            display: flex;
            align-items: center;
            border: 1px solid rgba(0,0,0,0.1);
            transition: all 0.3s;
            min-height: 48px;
            touch-action: manipulation;
        }

        .dark-mode .input-wrapper {
            border-color: rgba(255,255,255,0.1);
        }

        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.2);
        }

        .input-field {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text);
            font-size: 1rem;
            outline: none;
            resize: none;
            max-height: 120px;
            padding: 10px 0;
            line-height: 1.5;
            min-height: 40px;
            overflow-y: auto;
            font-family: inherit;
        }

        .input-field::placeholder {
            color: var(--text);
            opacity: 0.5;
        }

        .input-actions {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .input-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text);
            opacity: 0.7;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
            touch-action: manipulation;
        }

        .input-btn:hover {
            opacity: 1;
            background: rgba(0, 0, 0, 0.05);
            transform: scale(1.05);
        }

        .dark-mode .input-btn:hover {
            background: rgba(255,255,255,0.05);
        }

        .send-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            opacity: 1 !important;
            box-shadow: 0 2px 10px rgba(108, 92, 231, 0.3);
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .send-btn:hover {
            transform: scale(1.05) translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 92, 231, 0.4);
        }

        /* Voice Assistant Button */
        .voice-assistant {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(108, 92, 231, 0.3);
            cursor: pointer;
            z-index: 100;
            animation: pulse 2s infinite;
            transition: all 0.3s;
            border: 2px solid white;
            touch-action: manipulation;
        }

        .dark-mode .voice-assistant {
            border-color: var(--card-bg);
        }

        .voice-assistant:hover {
            transform: scale(1.1);
        }

        .voice-assistant.listening {
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108, 92, 231, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(108, 92, 231, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(108, 92, 231, 0); }
        }

        /* Image Attachment Preview */
        .attachment-preview {
            display: none;
            position: fixed;
            bottom: 80px;
            left: 20px;
            right: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 12px;
            box-shadow: var(--shadow);
            z-index: 80;
            max-height: 200px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            touch-action: manipulation;
        }

        .attachment-preview img {
            max-width: 100%;
            max-height: 160px;
            border-radius: 8px;
            display: block;
            margin: 8px auto;
        }

        .close-preview {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.2);
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.9rem;
            touch-action: manipulation;
        }

        /* Persona Selector */
        .persona-selector {
            position: fixed;
            bottom: 160px;
            right: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 12px;
            z-index: 85;
            display: none;
            min-width: 200px;
            max-height: 300px;
            overflow-y: auto;
            touch-action: manipulation;
        }

        .persona-item {
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            touch-action: manipulation;
        }

        .persona-item:hover {
            background: rgba(108, 92, 231, 0.1);
        }

        .persona-item.active {
            background: rgba(108, 92, 231, 0.2);
            border-left: 3px solid var(--primary);
        }

        .persona-item i {
            color: var(--primary);
        }

        /* Knowledge Base Search */
        .knowledge-search {
            position: fixed;
            top: 80px;
            right: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 12px;
            z-index: 85;
            display: none;
            min-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            touch-action: manipulation;
        }

        .knowledge-search input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
            margin-bottom: 12px;
            font-size: 0.9rem;
            touch-action: manipulation;
        }

        .knowledge-result {
            padding: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            cursor: pointer;
            font-size: 0.9rem;
            touch-action: manipulation;
        }

        .knowledge-result:hover {
            background: rgba(108, 92, 231, 0.05);
        }

        .knowledge-result:last-child {
            border-bottom: none;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--card-bg);
            color: var(--text);
            padding: 12px 20px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            z-index: 200;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            touch-action: manipulation;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .toast i {
            font-size: 1rem;
        }

        /* PWA Install Prompt */
        .pwa-prompt {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            border-radius: 24px;
            z-index: 999;
            display: none;
            font-size: 0.9rem;
            box-shadow: var(--shadow);
            animation: fadeInUp 0.5s ease-out;
            touch-action: manipulation;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .pwa-prompt button {
            color: white;
            background: transparent;
            border: none;
            text-decoration: underline;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
            touch-action: manipulation;
        }

        /* WebRTC Overlay */
        .rtc-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 900;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            touch-action: manipulation;
        }

        .rtc-call {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            touch-action: manipulation;
        }

        .rtc-call button {
            margin: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            touch-action: manipulation;
        }

        .rtc-call .join {
            background: var(--primary);
            color: white;
        }

        .rtc-call .leave {
            background: var(--error);
            color: white;
        }

        /* Responsive Adjustments */
        @media (max-width: 480px) {
            .header {
                padding: 10px 14px;
            }
            
            .logo {
                font-size: 1.3rem;
            }
            
            .header-btn,
            .user-avatar,
            .input-btn,
            .voice-assistant {
                width: 34px;
                height: 34px;
                font-size: 1rem;
            }
            
            .voice-assistant {
                width: 50px;
                height: 50px;
                font-size: 1.4rem;
                bottom: 90px;
                right: 16px;
            }
            
            .chat-container {
                padding: 12px;
                height: calc(100vh - 130px);
            }
            
            .input-area {
                padding: 10px 12px;
            }
            
            .input-wrapper {
                padding: 4px 12px;
            }
            
            .persona-selector,
            .knowledge-search {
                width: 90vw;
                max-width: 90vw;
                left: 5%;
                right: auto;
            }
            
            .knowledge-search {
                top: 70px;
            }
            
            .export-btn,
            .toggle-sidebar-btn {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
        }

        /* Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border: 0;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 70px;
            left: 0;
            height: calc(100vh - 70px);
            width: 280px;
            background: var(--card-bg);
            box-shadow: var(--shadow);
            z-index: 90;
            transition: transform 0.3s;
            transform: translateX(-100%);
            overflow-y: auto;
            padding: 16px;
            display: none;
        }

        .dark-mode .sidebar {
            background: var(--bg);
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .sidebar-title {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .toggle-sidebar-btn {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 4px;
        }

        .chat-history-item {
            padding: 12px 14px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .chat-history-item:hover {
            background: rgba(108, 92, 231, 0.05);
        }

        .chat-history-title {
            font-size: 0.9rem;
            font-weight: 500;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .chat-history-time {
            font-size: 0.7rem;
            color: var(--text);
            opacity: 0.6;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: var(--input-bg);
            border: 1px dashed var(--primary);
            border-radius: 10px;
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .new-chat-btn:hover {
            background: rgba(108, 92, 231, 0.1);
        }

        /* Export Button */
        .export-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow);
            z-index: 80;
            cursor: pointer;
            opacity: 0.8;
            transition: all 0.3s;
            touch-action: manipulation;
        }

        .export-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <!-- PWA Install Prompt -->
    <div class="pwa-prompt" id="pwaPrompt">
        Install NexusAI for offline access? <button id="installBtn">Install</button>
    </div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3 class="sidebar-title">Chat History</h3>
            <button class="toggle-sidebar-btn" id="closeSidebar"><i class="fas fa-times"></i></button>
        </div>

        <div id="historyList">
            <!-- Dynamically populated -->
        </div>

        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus"></i> New Chat
        </button>
    </aside>

    <!-- Header -->
    <div class="header">
        <div class="logo">
            <span class="logo-icon">N</span>
            NexusAI
        </div>
        <div class="header-actions">
            <button class="header-btn" id="themeToggle" aria-label="Toggle theme">
                <i class="fas fa-moon"></i>
            </button>
            <button class="header-btn" id="toggleSidebar" aria-label="Toggle chat history">
                <i class="fas fa-list"></i>
            </button>
            <button class="header-btn" id="personaToggle" aria-label="Select AI persona">
                <i class="fas fa-user-shield"></i>
            </button>
            <button class="header-btn" id="knowledgeToggle" aria-label="Search knowledge base">
                <i class="fas fa-book-open"></i>
            </button>
            <div class="user-avatar" id="userAvatar">U</div>
        </div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="message ai-message">
            <div class="message-sender">
                <i class="fas fa-robot"></i>
                NexusAI
            </div>
            <div class="message-bubble">
                <p>Hello! I'm your advanced AI assistant. I can help you with coding, analysis, creative writing, or just chat.</p>
                <p><strong>Try:</strong> ‚ÄúExplain quantum computing simply‚Äù or ‚ÄúAct as a doctor and diagnose this symptom.‚Äù</p>
                <img src="https://source.unsplash.com/random/300x200/?ai,technology" alt="AI Technology" onerror="this.style.display='none'" style="max-width: 100%; margin-top: 16px;">
            </div>
            <div class="message-time">Just now</div>
        </div>
    </div>

    <!-- Persona Selector -->
    <div class="persona-selector" id="personaSelector">
        <div class="persona-item active" data-persona="general">ü§ñ General Assistant</div>
        <div class="persona-item" data-persona="doctor">üë®‚Äç‚öïÔ∏è Doctor</div>
        <div class="persona-item" data-persona="lawyer">‚öñÔ∏è Lawyer</div>
        <div class="persona-item" data-persona="poet">üìö Poet</div>
        <div class="persona-item" data-persona="teacher">üéì Teacher</div>
        <div class="persona-item" data-persona="engineer">‚öôÔ∏è Engineer</div>
        <div class="persona-item" data-persona="business">üíº Business Strategist</div>
    </div>

    <!-- Knowledge Base Search -->
    <div class="knowledge-search" id="knowledgeSearch">
        <input type="text" id="knowledgeInput" placeholder="Search knowledge base..." autocomplete="off">
        <div id="knowledgeResults">
            <!-- Results loaded dynamically -->
        </div>
    </div>

    <!-- Image Attachment Preview -->
    <div class="attachment-preview" id="attachmentPreview">
        <button class="close-preview" id="closePreview"><i class="fas fa-times"></i></button>
        <img id="previewImage" src="" alt="Preview">
        <p id="previewCaption" style="margin-top: 8px; font-size: 0.8rem; color: var(--text); opacity: 0.7;">Uploaded image</p>
    </div>

    <!-- Input Area -->
    <div class="input-area">
        <div class="input-wrapper">
            <textarea class="input-field" id="messageInput" placeholder="Ask me anything..." rows="1" aria-label="Message input" autocomplete="off"></textarea>
        </div>
        <div class="input-actions">
            <button class="input-btn" id="attachBtn" title="Attach Image" aria-label="Attach image">
                <i class="fas fa-image"></i>
            </button>
            <button class="input-btn" id="voiceBtn" title="Voice Input" aria-label="Voice input">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="input-btn send-btn" id="sendBtn" title="Send message" aria-label="Send message">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Voice Assistant Button -->
    <div class="voice-assistant" id="voiceAssistant">
        <i class="fas fa-microphone"></i>
    </div>

    <!-- Export Button -->
    <button class="export-btn" id="exportBtn" title="Export conversation" aria-label="Export chat">
        <i class="fas fa-download"></i>
    </button>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Login to NexusAI</div>
                <button class="close-modal" id="closeLoginModal">&times;</button>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="loginEmail">Email</label>
                    <input type="email" class="form-input" id="loginEmail" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="loginPassword">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required autocomplete="current-password">
                </div>
                <button type="submit" class="submit-btn">Sign In</button>
                <div class="form-footer">
                    Don't have an account? <span class="switch-form" id="showSignup">Create Account</span>
                </div>
            </form>
        </div>
    </div>

    <!-- Signup Modal -->
    <div class="modal" id="signupModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Create Your Account</div>
                <button class="close-modal" id="closeSignupModal">&times;</button>
            </div>
            <form id="signupForm">
                <div class="form-group">
                    <label class="form-label" for="signupName">Full Name</label>
                    <input type="text" class="form-input" id="signupName" required autocomplete="name">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupEmail">Email</label>
                    <input type="email" class="form-input" id="signupEmail" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupPassword">Password</label>
                    <input type="password" class="form-input" id="signupPassword" required autocomplete="new-password">
                </div>
                <div class="form-group">
                    <label class="form-label" for="signupConfirmPassword">Confirm Password</label>
                    <input type="password" class="form-input" id="signupConfirmPassword" required autocomplete="new-password">
                </div>
                <button type="submit" class="submit-btn">Create Account</button>
                <div class="form-footer">
                    Already have an account? <span class="switch-form" id="showLogin">Sign In</span>
                </div>
            </form>
        </div>
    </div>

    <!-- WebRTC Call Overlay -->
    <div class="rtc-overlay" id="rtcOverlay">
        <div class="rtc-call">
            <h3>Collaborative Session</h3>
            <p>Your session ID: <strong id="rtcSessionId">-</strong></p>
            <button class="join" id="rtcJoin">Join Session</button>
            <button class="leave" id="rtcLeave">Leave</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastText"></span>
    </div>

    <script>
        // DOM Elements
        const chatContainer = document.getElementById('chatContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const themeToggle = document.getElementById('themeToggle');
        const voiceAssistant = document.getElementById('voiceAssistant');
        const attachBtn = document.getElementById('attachBtn');
        const attachmentPreview = document.getElementById('attachmentPreview');
        const previewImage = document.getElementById('previewImage');
        const previewCaption = document.getElementById('previewCaption');
        const closePreview = document.getElementById('closePreview');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const loginModal = document.getElementById('loginModal');
        const signupModal = document.getElementById('signupModal');
        const closeLoginModal = document.getElementById('closeLoginModal');
        const closeSignupModal = document.getElementById('closeSignupModal');
        const showSignup = document.getElementById('showSignup');
        const showLogin = document.getElementById('showLogin');
        const loginForm = document.getElementById('loginForm');
        const signupForm = document.getElementById('signupForm');
        const sidebar = document.getElementById('sidebar');
        const toggleSidebar = document.getElementById('toggleSidebar');
        const closeSidebar = document.getElementById('closeSidebar');
        const historyList = document.getElementById('historyList');
        const newChatBtn = document.getElementById('newChatBtn');
        const exportBtn = document.getElementById('exportBtn');
        const toast = document.getElementById('toast');
        const toastText = document.getElementById('toastText');
        const personaSelector = document.getElementById('personaSelector');
        const personaToggle = document.getElementById('personaToggle');
        const knowledgeSearch = document.getElementById('knowledgeSearch');
        const knowledgeToggle = document.getElementById('knowledgeToggle');
        const knowledgeInput = document.getElementById('knowledgeInput');
        const knowledgeResults = document.getElementById('knowledgeResults');
        const rtcOverlay = document.getElementById('rtcOverlay');
        const rtcSessionId = document.getElementById('rtcSessionId');
        const rtcJoin = document.getElementById('rtcJoin');
        const rtcLeave = document.getElementById('rtcLeave');
        const pwaPrompt = document.getElementById('pwaPrompt');
        const installBtn = document.getElementById('installBtn');

        // App State
        let isDarkMode = false;
        let isListening = false;
        let recognition;
        let selectedImage = null;
        let currentSessionId = generateSessionId();
        let currentUser = null;
        let currentPersona = 'general';
        let db;
        let isTyping = false;
        let peerConnection;
        let dataChannel;

        // Initialize IndexedDB for large histories
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('NexusAIDB', 1);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('conversations')) {
                        const store = db.createObjectStore('conversations', { keyPath: 'sessionId', autoIncrement: false });
                        store.createIndex('userId', 'userId', { unique: false });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                    }
                    if (!db.objectStoreNames.contains('knowledge')) {
                        const store = db.createObjectStore('knowledge', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('category', 'category', { unique: false });
                        store.createIndex('content', 'content', { unique: false });
                    }
                };
            });
        }

        // Save conversation to IndexedDB
        async function saveConversationToDB() {
            const messages = Array.from(chatContainer.children).map(el => {
                const sender = el.classList.contains('user-message') ? 'user' : 'ai';
                const text = el.querySelector('.message-bubble').innerHTML;
                return { sender, text, time: new Date().toISOString() };
            });

            const tx = db.transaction('conversations', 'readwrite');
            const store = tx.objectStore('conversations');
            const record = {
                sessionId: currentSessionId,
                userId: currentUser?.email || 'anonymous',
                messages: messages,
                timestamp: Date.now(),
                persona: currentPersona
            };

            await new Promise((resolve, reject) => {
                const req = store.put(record);
                req.onsuccess = resolve;
                req.onerror = () => reject(req.error);
            });

            addToHistory(currentSessionId, messages[0]?.text?.substring(0, 40) || 'New Chat');
        }

        // Load conversation from IndexedDB
        async function loadConversationFromDB(sessionId) {
            const tx = db.transaction('conversations', 'readonly');
            const store = tx.objectStore('conversations');
            const req = store.get(sessionId);

            return new Promise((resolve, reject) => {
                req.onsuccess = () => {
                    if (req.result) {
                        currentSessionId = sessionId;
                        currentPersona = req.result.persona || 'general';
                        updatePersonaUI(currentPersona);
                        chatContainer.innerHTML = '';
                        req.result.messages.forEach(msg => {
                            addMessage(msg.sender, msg.text);
                        });
                        showToast('Loaded previous chat', 'success');
                        resolve();
                    } else {
                        resolve();
                    }
                };
                req.onerror = () => reject(req.error);
            });
        }

        // Populate knowledge base (mock data)
        async function populateKnowledgeBase() {
            const knowledgeData = [
                { category: 'medical', content: 'Common symptoms of diabetes include frequent urination, excessive thirst, unexplained weight loss, and fatigue.' },
                { category: 'legal', content: 'In contract law, consideration is something of value exchanged between parties to form a binding agreement.' },
                { category: 'literary', content: 'Poetry often uses metaphor, rhythm, and imagery to evoke emotion beyond literal meaning.' },
                { category: 'education', content: 'The Socratic method encourages critical thinking through disciplined questioning.' },
                { category: 'engineering', content: 'Finite element analysis (FEA) is used to predict how structures react to forces, vibrations, heat, and other physical effects.' },
                { category: 'business', content: 'SWOT analysis evaluates Strengths, Weaknesses, Opportunities, and Threats for strategic planning.' }
            ];

            const tx = db.transaction('knowledge', 'readwrite');
            const store = tx.objectStore('knowledge');

            for (const item of knowledgeData) {
                await new Promise((resolve, reject) => {
                    const req = store.add(item);
                    req.onsuccess = resolve;
                    req.onerror = () => reject(req.error);
                });
            }
        }

        // Search knowledge base
        async function searchKnowledge(query) {
            if (!query.trim()) return;
            knowledgeResults.innerHTML = '<p class="skeleton-text" style="height: 20px;"></p>';

            const tx = db.transaction('knowledge', 'readonly');
            const store = tx.objectStore('knowledge');
            const index = store.index('content');
            const req = index.getAll();

            return new Promise((resolve) => {
                req.onsuccess = () => {
                    const results = req.result.filter(item =>
                        item.content.toLowerCase().includes(query.toLowerCase())
                    ).slice(0, 5);

                    knowledgeResults.innerHTML = '';
                    if (results.length === 0) {
                        knowledgeResults.innerHTML = '<p>No results found.</p>';
                        resolve([]);
                        return;
                    }

                    results.forEach(item => {
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'knowledge-result';
                        resultDiv.textContent = item.content.substring(0, 150) + '...';
                        resultDiv.onclick = () => {
                            addMessage('ai', `Based on my knowledge: ${item.content}`);
                            knowledgeSearch.style.display = 'none';
                        };
                        knowledgeResults.appendChild(resultDiv);
                    });
                    resolve(results);
                };
                req.onerror = () => {
                    knowledgeResults.innerHTML = '<p>Error loading knowledge.</p>';
                    resolve([]);
                };
            });
        }

        // Toggle persona selector
        personaToggle.addEventListener('click', () => {
            personaSelector.style.display = personaSelector.style.display === 'flex' ? 'none' : 'flex';
            knowledgeSearch.style.display = 'none';
        });

        // Select persona
        personaSelector.querySelectorAll('.persona-item').forEach(item => {
            item.addEventListener('click', () => {
                const persona = item.dataset.persona;
                currentPersona = persona;
                updatePersonaUI(persona);
                personaSelector.style.display = 'none';
                showToast(`Persona set to: ${item.textContent}`, 'success');
                addMessage('ai', `I am now acting as a ${persona === 'doctor' ? 'medical professional' : persona === 'poet' ? 'poet' : persona}.`);
            });
        });

        function updatePersonaUI(persona) {
            personaSelector.querySelectorAll('.persona-item').forEach(item => {
                item.classList.toggle('active', item.dataset.persona === persona);
            });
        }

        // Knowledge search
        knowledgeToggle.addEventListener('click', () => {
            knowledgeSearch.style.display = knowledgeSearch.style.display === 'flex' ? 'none' : 'flex';
            personaSelector.style.display = 'none';
            knowledgeInput.focus();
        });

        knowledgeInput.addEventListener('input', debounce(async (e) => {
            await searchKnowledge(e.target.value);
        }, 300));

        // Debounce utility
        function debounce(func, delay) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, delay);
            };
        }

        // WebRTC Real-Time Collaboration
        async function initWebRTC() {
            const pcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
            peerConnection = new RTCPeerConnection(pcConfig);
            dataChannel = peerConnection.createDataChannel('chat');

            dataChannel.onopen = () => {
                showToast('Collaboration connected!', 'success');
            };

            dataChannel.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'message') {
                    addMessage(msg.sender, msg.text);
                }
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('ICE Candidate:', event.candidate);
                }
            };

            // Offer creation
            rtcJoin.addEventListener('click', async () => {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                rtcSessionId.textContent = currentSessionId;
                showToast(`Share this ID: ${currentSessionId} with a collaborator`, 'info');
            });

            // Join session by ID (mock)
            document.addEventListener('keydown', async (e) => {
                if (e.ctrlKey && e.key === 'j') {
                    const sessionId = prompt('Enter session ID to join:');
                    if (sessionId) {
                        alert(`Mock: Joined session ${sessionId}`);
                    }
                }
            });

            rtcLeave.addEventListener('click', () => {
                peerConnection.close();
                rtcOverlay.style.display = 'none';
                showToast('Left collaborative session', 'info');
            });

            // Show overlay
            document.getElementById('toggleCollab').addEventListener('click', () => {
                rtcOverlay.style.display = 'flex';
            });
        }

        // Initialize PWA
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            pwaPrompt.style.display = 'block';
        });

        installBtn.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    pwaPrompt.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        // Initialize App
        async function initializeApp() {
            await initIndexedDB();
            await populateKnowledgeBase();

            // Check for saved theme
            if (localStorage.getItem('darkMode') === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }

            // Check for saved user
            const savedUser = localStorage.getItem('nexusUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUIForUser(currentUser);
                loadConversationHistory();
            }

            // Load last session if exists
            const lastSessionId = localStorage.getItem('lastSessionId');
            if (lastSessionId) {
                await loadConversationFromDB(lastSessionId);
            }

            // Init WebRTC
            initWebRTC();

            // Add welcome message
            setTimeout(() => {
                addMessage('ai', 'üí° Tip: Press <kbd>Ctrl+J</kbd> to join a collaborative session!');
            }, 2000);
        }

        // Toggle Dark Mode
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            themeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            localStorage.setItem('darkMode', isDarkMode);
            showToast('Theme toggled', 'success');
        }

        // Toggle Sidebar
        toggleSidebar.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        closeSidebar.addEventListener('click', () => {
            sidebar.classList.remove('open');
        });

        // Image Attachment
        attachBtn.addEventListener('click', () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        selectedImage = event.target.result;
                        previewImage.src = selectedImage;
                        previewCaption.textContent = file.name;
                        attachmentPreview.style.display = 'flex';
                        addMessage('ai', `You've attached "${file.name}". I can analyze this image.`);
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        });

        closePreview.addEventListener('click', () => {
            attachmentPreview.style.display = 'none';
            selectedImage = null;
        });

        // Send Message Function
        async function sendMessage() {
            if (isTyping) return;
            const message = messageInput.value.trim();
            if (!message && !selectedImage) return;

            isTyping = true;
            messageInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            addMessage('user', message);
            if (selectedImage) {
                const lastMsg = chatContainer.lastElementChild;
                const bubble = lastMsg.querySelector('.message-bubble');
                const img = document.createElement('img');
                img.src = selectedImage;
                img.alt = 'User uploaded image';
                img.style.maxWidth = '100%';
                img.style.marginTop = '12px';
                img.onerror = () => {
                    const errorMsg = document.createElement('p');
                    errorMsg.textContent = '[Image failed to load]';
                    errorMsg.style.fontStyle = 'italic';
                    errorMsg.style.opacity = '0.7';
                    bubble.appendChild(errorMsg);
                };
                bubble.appendChild(img);
                selectedImage = null;
                attachmentPreview.style.display = 'none';
            }

            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.focus();

            const typingId = showTypingIndicator();

            try {
                const response = await callLLMBackend(message);
                removeTypingIndicator(typingId);
                addMessage('ai', formatResponse(response));
                saveConversationToDB();
                localStorage.setItem('lastSessionId', currentSessionId);
            } catch (err) {
                removeTypingIndicator(typingId);
                addMessage('ai', `‚ö†Ô∏è Error contacting AI service: ${err.message}. Try again later.`);
            } finally {
                isTyping = false;
                messageInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            }
        }

        // Call LLM Backend (Mock)
        async function callLLMBackend(prompt) {
            const payload = {
                prompt: prompt,
                persona: currentPersona,
                model: 'gpt-4o-mini'
            };

            // Simulate API delay
            await new Promise(r => setTimeout(r, 1000));

            let response = '';

            if (currentPersona === 'doctor') {
                response = `As a medical professional, I'd say: Based on your description, common causes could include dehydration, stress, or minor infection. However, for accurate diagnosis, consult a licensed physician. Avoid self-diagnosis for persistent symptoms.`;
            } else if (currentPersona === 'poet') {
                response = `Like moonlight on still water, your question ripples through silence‚Äîeach word a stanza, each thought a breath held too long. What is it you seek? A truth? A rhyme? Or just the echo of your soul reflected in ink?`;
            } else if (currentPersona === 'lawyer') {
                response = `Legally speaking, under common law principles, liability hinges on duty, breach, causation, and damages. Without specific jurisdictional context, I cannot provide definitive advice. Consult a qualified attorney for actionable counsel.`;
            } else if (currentPersona === 'teacher') {
                response = `Let's break this down step by step. First, understand the core concept. Then, relate it to what you already know. Practice with examples. Finally, teach it to someone else‚Äîthat‚Äôs how mastery forms.`;
            } else if (currentPersona === 'engineer') {
                response = `Engineers approach problems systematically. Here's a framework: define the problem ‚Üí gather data ‚Üí prototype ‚Üí test ‚Üí iterate. For your case, consider [specific solution].`;
            } else if (currentPersona === 'business') {
                response = `Strategically, this requires evaluating ROI, market fit, and scalability. I recommend starting with a MVP, validating demand via surveys, then scaling based on feedback.`;
            } else {
                response = `I've analyzed your request: "${prompt}" Here's my insight: The key is to focus on clarity, context, and consistency. Would you like me to expand on any part?`;
            }

            return response;
        }

        // Format response with markdown
        function formatResponse(text) {
            text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                const language = lang || 'plaintext';
                return `<div class="code-block"><div class="code-header"><span>${language}</span><button class="copy-code-btn" onclick="copyToClipboard('${code.replace(/'/g, "\\'")}')">Copy</button></div>${highlightCode(code, language)}</div>`;
            });

            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" style="color: var(--primary); text-decoration: underline;">$1</a>');

            return text;
        }

        function highlightCode(code, language) {
            if (language === 'javascript' || language === 'js') {
                return code.replace(/(\/\/.*$|\/\*[\s\S]*?\*\/|".*?"|'.*?'|\b(function|const|let|var|return|if|else|for|while|class|extends|import|export|default)\b)/gm, (match) => {
                    if (match.startsWith('//')) return `<span style="color: #6c757d;">${match}</span>`;
                    if (match.startsWith('/*')) return `<span style="color: #6c757d;">${match}</span>`;
                    if (match.startsWith('"') || match.startsWith("'")) return `<span style="color: #d35400;">${match}</span>`;
                    return `<span style="color: #2980b9;">${match}</span>`;
                });
            }
            return code;
        }

        // Copy to clipboard
        window.copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied to clipboard!', 'success');
            }).catch(err => {
                showToast('Failed to copy.', 'error');
            });
        };

        // Add message to chat
        function addMessage(sender, text) {
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const senderName = sender === 'user' ? 'You' : 'NexusAI';
            const avatarIcon = sender === 'user' ? 'fa-user' : 'fa-robot';

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = `
                <div class="message-sender">
                    <i class="fas ${avatarIcon}"></i>
                    ${senderName}
                </div>
                <div class="message-bubble">${text}</div>
                <div class="message-time">${time}</div>
                <div class="message-actions">
                    <button class="message-action-btn copy-btn" title="Copy"><i class="fas fa-copy"></i></button>
                    <button class="message-action-btn delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
                </div>
            `;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const typingId = 'typing-' + Date.now();
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai-message';
            typingDiv.id = typingId;
            typingDiv.innerHTML = `
                <div class="message-sender">
                    <i class="fas fa-robot"></i>
                    NexusAI
                </div>
                <div class="message-bubble">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return typingId;
        }

        // Remove typing indicator
        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // Voice Assistant
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                voiceAssistant.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                voiceAssistant.classList.add('listening');
                addMessage('ai', 'Listening... Speak clearly.');
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim();
                messageInput.value = transcript;
                sendMessage();
            };

            recognition.onerror = (event) => {
                console.warn('Speech recognition error:', event.error);
                addMessage('ai', 'Voice input failed. Please try again or use text.');
            };

            recognition.onend = () => {
                isListening = false;
                voiceAssistant.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceAssistant.classList.remove('listening');
            };
        } else {
            document.getElementById('voiceBtn').style.display = 'none';
            voiceAssistant.style.display = 'none';
        }

        voiceAssistant.addEventListener('click', () => {
            if (!recognition) {
                showToast('Voice input not supported in this browser.', 'error');
                return;
            }
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        document.getElementById('voiceBtn').addEventListener('click', () => {
            if (!recognition) {
                showToast('Voice input not supported.', 'error');
                return;
            }
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Send on Enter
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        // Modals
        loginBtn.addEventListener('click', () => loginModal.style.display = 'flex');
        signupBtn.addEventListener('click', () => signupModal.style.display = 'flex');

        closeLoginModal.addEventListener('click', () => loginModal.style.display = 'none');
        closeSignupModal.addEventListener('click', () => signupModal.style.display = 'none');

        showSignup.addEventListener('click', () => {
            loginModal.style.display = 'none';
            signupModal.style.display = 'flex';
        });

        showLogin.addEventListener('click', () => {
            signupModal.style.display = 'none';
            loginModal.style.display = 'flex';
        });

        window.addEventListener('click', (e) => {
            if (e.target === loginModal) loginModal.style.display = 'none';
            if (e.target === signupModal) signupModal.style.display = 'none';
        });

        // Form Submissions
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            showToast('Logging in...', 'success');
            await new Promise(r => setTimeout(r, 1500));

            currentUser = { name: email.split('@')[0], email, token: 'mock-jwt-token' };
            localStorage.setItem('nexusUser', JSON.stringify(currentUser));
            updateUIForUser(currentUser);
            loginModal.style.display = 'none';
            loadConversationHistory();
            showToast(`Welcome back, ${currentUser.name}!`, 'success');
        });

        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirm = document.getElementById('signupConfirmPassword').value;

            if (password !== confirm) {
                showToast('Passwords do not match!', 'error');
                return;
            }

            showToast('Creating account...', 'success');
            await new Promise(r => setTimeout(r, 1500));

            currentUser = { name, email, token: 'mock-jwt-token' };
            localStorage.setItem('nexusUser', JSON.stringify(currentUser));
            updateUIForUser(currentUser);
            signupModal.style.display = 'none';
            loadConversationHistory();
            showToast(`Welcome aboard, ${name}!`, 'success');
        });

        function updateUIForUser(user) {
            document.getElementById('userAvatar').textContent = user.name.charAt(0).toUpperCase();
            document.querySelectorAll('.auth-btn').forEach(btn => btn.style.display = 'none');
        }

        // Generate Session ID
        function generateSessionId() {
            return 'sess_' + Math.random().toString(36).substring(2, 15);
        }

        // Add to history
        function addToHistory(sessionId, title) {
            const item = document.createElement('div');
            item.className = 'chat-history-item';
            item.innerHTML = `
                <div class="chat-history-title">${title}</div>
                <div class="chat-history-time">${new Date().toLocaleDateString()}</div>
            `;
            item.addEventListener('click', async () => {
                await loadConversationFromDB(sessionId);
            });
            historyList.prepend(item);
        }

        // Load history
        async function loadConversationHistory() {
            historyList.innerHTML = '';
            const tx = db.transaction('conversations', 'readonly');
            const store = tx.objectStore('conversations');
            const req = store.getAll();

            req.onsuccess = () => {
                req.result.sort((a, b) => b.timestamp - a.timestamp).slice(0, 10).forEach(item => {
                    const firstMsg = item.messages[0]?.text?.substring(0, 40) || 'Empty';
                    addToHistory(item.sessionId, firstMsg + (firstMsg.length > 40 ? '...' : ''));
                });
            };
        }

        // Export Conversation
        exportBtn.addEventListener('click', () => {
            const messages = Array.from(chatContainer.children).map(el => {
                const sender = el.classList.contains('user-message') ? 'user' : 'ai';
                const text = el.querySelector('.message-bubble').innerText;
                return { sender, text, time: new Date().toISOString() };
            });

            const blob = new Blob([JSON.stringify({
                session: currentSessionId,
                messages,
                user: currentUser,
                persona: currentPersona,
                exportedAt: new Date().toISOString()
            }, null, 2)], { type: 'application/json' });

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nexusai-conversation-${currentSessionId}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Conversation exported!', 'success');
        });

        // New Chat
        newChatBtn.addEventListener('click', async () => {
            currentSessionId = generateSessionId();
            chatContainer.innerHTML = '';
            addMessage('ai', 'Hello! I‚Äôm your AI assistant. How can I help you today?');
            showToast('New chat started', 'success');
        });

        // Toast Notification
        function showToast(message, type = 'success') {
            toast.className = `toast ${type}`;
            toastText.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js').then(registration => {
                    console.log('SW registered:', registration);
                }).catch(err => {
                    console.log('SW registration failed:', err);
                });
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                messageInput.focus();
            }
            if (e.ctrlKey && e.key === 'j') {
                e.preventDefault();
                rtcOverlay.style.display = 'flex';
            }
            if (e.ctrlKey && e.key === 'p') {
                e.preventDefault();
                personaToggle.click();
            }
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                knowledgeToggle.click();
            }
        });

        // Handle paste image
        messageInput.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    e.preventDefault();
                    const blob = items[i].getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        selectedImage = event.target.result;
                        previewImage.src = selectedImage;
                        previewCaption.textContent = 'Pasted image';
                        attachmentPreview.style.display = 'flex';
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });

        // Theme toggle
        themeToggle.addEventListener('click', toggleTheme);
    </script>
</body>
</html>
